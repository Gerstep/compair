<div ng-controller="QuestionViewController" class="question-screen">
	
	<div class="standalone-question">
		
		<!-- Question -->
		<h2><i class="fa fa-comments"></i> {{question.title}}</h2>
		
		<!-- Question Details -->
		<div class="questionmathjax question-desc" mathjax="question.post.content"
			 ng-bind-html="question.post.content">
		</div>
		
		<!-- Question Attachment -->
		<acj-pdf-inline label="See question details:" pdfs="question.post.files">
		</acj-pdf-inline>
		
		<!-- Question Answer/Evaluation Periods -->
		<div ng-show="canManagePosts">
			<p><em>Answering Period: {{question.answer_start | amDateFormat: 'MMM D @ h:mm a'}} - {{question.answer_end | amDateFormat: 'MMM D @ h:mm a'}}
			<span ng-if="question.judge_start > 0 && question.judge_end > 0"><br />Comparing Period: {{question.judge_start | amDateFormat: 'MMM D @ h:mm a'}} - {{question.judge_end | amDateFormat: 'MMM D @ h:mm a'}}</em></p>
		</div>
		
		<!-- Question Metadata Footer -->
		<ul class="list-inline question-metadata-list">
			<li ng-if="canManagePosts || question.post.user.id == loggedInUserId">	
				<a ng-href="#/course/{{courseId}}/question/{{question.id}}/edit" ng-if="canManagePosts || question.post.user.id == loggedInUserId" title="Edit">
					Edit
				</a> 
			</li>
			<li>
				Posted by 
				<a ng-href="#/user/{{question.post.user.id}}">
					{{question.post.user.displayname}}
					<span ng-if="canManagePosts && question.post.user.fullname">
						({{question.post.user.fullname}})
					</span>
					<span ng-if="canManagePosts && !question.post.user.fullname">
						({{question.post.user.username}})
					</span>
				</a>
			</li>
			<li ng-if="!canManagePosts && ((evaluation + selfEval == 0) || answered)">
				You have
				<span ng-if="answered">answered <span ng-if="evaluation + selfEval == 0">and </span></span>
				<span ng-if="evaluation + selfEval == 0">compared</span>
			</li>
			<li ng-if="!canManagePosts && question.answer_period && !answered">
				<strong>Answer due {{question.answer_end | amDateFormat: 'MMM D @ h:mm a'}}</strong>
			</li>
			<li ng-if="!canManagePosts && question.judging_period && (evaluation + selfEval > 0)">
				<strong>{{ evaluation + selfEval }} comparison<span ng-if="(evaluation + selfEval) != 1">s</span> needed from you</strong>
			</li>
			<li ng-if="canManagePosts || question.post.user.id == loggedInUserId">
				<a ng-if="canManagePosts || question.post.user.id == loggedInUserId" title="Delete" confirmation-needed="deleteQuestion(courseId, question.id)" keyword="question">
					<i class="fa fa-trash-o"></i>
				</a>
			</li>
		</ul>
		
		<!-- Question Actions -->
		
		<!-- BUTTON when user has not answered AND (user is an admin OR the answer period is active) -->
		<a ng-href="#/course/{{courseId}}/question/{{question.id}}/answer/create" class="btn btn-success" title="Answer Question"
		   ng-show="!answered && (canManagePosts || question.answer_period)">
			Answer
		</a>
		
		<!-- BUTTON when user is not an admin AND the comparison period is active AND the user has not finished pair comparisons AND either (the answer period is active AND the question has been answered) OR (the answer period is not active)
			 basically we force users to answer first, if they can
			 enabled only when answer pairs are available for comparison (so when no warning)
		-->
		<a class="btn" ng-class="{'btn-success': !warning, 'btn-default': warning}" title="Compare Answers" ng-href="#/course/{{courseId}}/question/{{question.id}}/compare"
		   ng-show="!canManagePosts && question.judging_period && !judged_req_met && ((question.answer_period && answered) || !question.answer_period)" ng-disabled="warning">
			Compare Answers
		</a>
		
		<!-- BUTTON when user is not an admin AND the comparison period is active AND user has finished pair comparisons AND has a self-evaluation remaining AND either (the answer period is active AND the question has been answered) OR (the answer period is not active)
			 basically we force users to answer first, if they can
			 enabled only when user has answered question
		-->
		<a class="btn" ng-class="{'btn-success': answered, 'btn-default': !answered}" title="Self-Evaluation" ng-href="#/course/{{courseId}}/question/{{question.id}}/selfevaluation"
		   ng-show="!canManagePosts && question.judging_period && judged_req_met && !selfEval_req_met && ((question.answer_period && answered) || !question.answer_period)" ng-disabled="!answered">
			Compare Answers
		</a>
		
		<!-- BUTTON when user is an admin AND (the comparison period is active OR is complete) -->
		<a class="btn btn-success" title="Comparisons" ng-href="#/course/{{courseId}}/question/{{question.id}}/comparisons"
		   ng-show="canManagePosts && (question.judging_period || question.after_judging)">
			See Comparisons
		</a>
		
		<!-- ADDITIONAL TEXT when answer pairs are not available for comparison AND user is not admin AND the comparison period is active AND user has comparisons remaining-->
		<p ng-if="warning && !canManagePosts && question.judging_period && (evaluation + selfEval > 0)"><em>Not enough answers to compare (Refresh the page to check again) </em></p>
		
		<!-- ADDITIONAL TEXT when user is not an admin AND the comparison period is active AND user has completed pair comparisons AND has a self-evaluation remaining AND has not answered question -->
		<p ng-if="!canManagePosts && question.judging_period && judged_req_met && !selfEval_req_met && !answered"><em>Self-evaluation comparison unavailable (You have not answered the question) </em></p>
		
	</div><!-- closes question box -->
	
	<!-- Tabs -->
	<ul class="nav nav-tabs" role="tablist">
	  <li id="answers" class="active">
		<a href="#answers-tab">Answers <span ng-show="canManagePosts || !question.answer_period">({{question.answers_count}})</span></a>
	  </li>
	  <li id="comments">
		<a href="#comments-tab">Help</a>
	  </li>
	  <li ng-show="canManagePosts" id="participation">
		  <a href="#participation-tab">Participation</a>
	  </li>
	</ul>
	
	<!-- Tab Content -->
	<div class="tab-content">
		
		<div class="tab-pane active" id="answers-tab">
			
			<!-- Answers Tab Header -->
			<div class="tab-header">
				
				<div ng-if="question.answers_count && (canManagePosts || see_answers)" class="pull-right text-right">
					<span class="filter">
						<label>Show: </label>
						<select ng-if="groups.length > 0 && canManagePosts" ng-model="grade.group" class="nullable"
							ng-options="g as g.name for g in groups | orderBy: 'name'" ng-change="groupChange()">
							<option value="">All groups</option>
						</select>
						<select ng-model="grade.author" class="nullable"
								ng-options="u as u.user.name for u in students | orderBy: 'user.name'" ng-change="userChange()">
							<option value="">All students</option>
						</select>
					</span><br />
					<span class="filter">
						<label>Order by scores for: &nbsp;</label>
						<select ng-model="grade.sortby"
							ng-options="key as c.criterion.name for (key, c) in criteria" ng-change="criteriaChange()">
						</select>
					</span>
				</div>

				<h2>
					Answers
					<span ng-show="canManagePosts && grade.group && !grade.author">for "{{grade.group.name}}"</span>
					<span ng-show="grade.author">for "{{ grade.author.user.name }}"</span>
				</h2>

				<!-- Instructors should see before the answer period -->
				<p class="intro-text"
				   ng-if="canManagePosts && !question.answer_period && !question.available">
					Answering period begins {{question.answer_start | amDateFormat: 'MMM D @ h:mm a'}}. Would you like to <a ng-href="#/course/{{courseId}}/question/{{question.id}}/edit" title="Edit the question">change the answer date</a> for this question?
				</p>
				
				<!-- Students should see before answering during the answer period -->
				<p class="intro-text"
				   ng-if="!canManagePosts && !answered && question.answer_period">
					<a ng-href="#/course/{{courseId}}/question/{{question.id}}/answer/create" title="Answer the question">Answer</a> and compare answer pairs for the question first, then read all answers written by your classmates and instructors here.
				</p>
				
				<!-- Students should see before evaluating before the evaluation period -->
				<p class="intro-text"
				   ng-if="!canManagePosts && ((answered && question.answer_period) || (!question.answer_period)) && !question.judging_period && !question.after_judging">
					Comparison period begins <span ng-if="question.judge_start > 0">{{question.judge_start | amDateFormat: 'MMM D @ h:mm a'}}</span> <span ng-if="question.judge_start <= 0">after the answer period ends</span>. After comparing  answer pairs, you will be able to read all answers written by your classmates and instructors here.
				</p>
				
				<!-- Students should see before evaluating during the evaluation period (regular comparison) -->
				<p class="intro-text" ng-if="!canManagePosts && question.judging_period && !judged_req_met">
					<a ng-href="#/course/{{courseId}}/question/{{question.id}}/compare" title="Compare answers">Compare answers</a> for the question first, then read answers written by your classmates and instructors here.
				</p>
				
				<!-- Students should see before evaluating during the evaluation period (self-evaluation) -->
				<p class="intro-text" ng-if="!canManagePosts && question.judging_period && judged_req_met && !selfEval_req_met">
					<a ng-href="#/course/{{courseId}}/question/{{question.id}}/judgement" title="Compare answers">Compare answers</a> for the question first, then read answers written by your classmates and instructors here.
				</p>
				
				<!-- Anyone sees during the answer period, if no answers provided yet -->
				<p class="intro-text" ng-if="question.answer_period && !question.answers_count">
					No answers given for this question yet.
				</p>
				
				<!-- Students see after evaluating before the evaluation period is over -->
				<p class="intro-text" ng-if="!canManagePosts && judged_req_met && selfEval_req_met && !see_answers">
					You have successfully finished comparisons for this question! Answers written by your classmates and instructors will be available here beginning <strong>{{ answerAvail | amDateFormat: 'MMM D @ h:mm a'}}</strong>.
				</p>
				
			</div>
			
			<div class="all-answers">
			
				<!-- Instructor Answers Section -->
				<div class="each-answer clearfix" ng-repeat="(answerKey, answer) in answers | filter:adminFilter()" ng-if="instructors[answer.post.user.id] && (see_answers || canManagePosts)">
					
					<!-- Instructor Answer Metadata Header -->
					<a ng-href="#/user/{{answer.post.user.id}}">
						<img src="//www.gravatar.com/avatar/{{answer.post.user.avatar}}?s=32&d=retro" />
					</a>
					<a ng-href="#/user/{{answer.post.user.id}}">
						{{answer.post.user.displayname}}
						<span ng-if="canManagePosts && answer.post.user.fullname">
							({{answer.post.user.fullname}})
						</span>
						<span ng-if="canManagePosts && !answer.post.user.fullname">
							({{answer.post.user.username}})
						</span>
					</a>
					<span class="label label-info" ng-if="instructors[answer.post.user.id]">{{instructors[answer.post.user.id]}}&nbsp;</span>
					<strong>said</strong>:
					<div class="manager-actions pull-right" ng-if="canManagePosts">
						<a href="" confirmation-needed="deleteAnswer(answerKey, courseId, question.id, answer.id)" keyword="instructor answer">
							<i class="fa fa-trash-o"></i>
						</a>
						<a href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/edit">
							Edit
						</a>
					</div>
					
					<!-- Instructor Answer -->
					<div class="content">
						<div mathjax="answer.post.content"
							ng-bind-html="answer.post.content">
						</div>
						<!-- Instructor Attachment -->
						<acj-pdf-inline label="See question details:" 
							pdfs="answer.post.files">
						</acj-pdf-inline>
					</div>
					
					<!-- Instructor Answer Replies Section -->
					<a href="" ng-click="showReplies = !showReplies">			
						<h3 class="reply-heading" ng-if="answer.comments.length">
							<i class="fa fa-chevron-down" ng-show="showReplies"></i>
							<i class="fa fa-chevron-right" ng-hide="showReplies"></i>
							{{answer.comments.length}}
							<span ng-if="answer.comments.length == 1">reply</span>
							<span ng-if="answer.comments.length > 1">replies</span>
							to instructor's answer
						</h3>
					</a>
					
					<div ng-show="showReplies">
						
						<div ng-repeat="(commentKey, comment) in answer.comments" class="each-reply" >
							
							<hr ng-hide="$first" />
							
							<!-- Instructor Reply Metadata Header -->
							<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
								<img src="//www.gravatar.com/avatar/{{comment.postsforcomments.post.user.avatar}}?s=32&d=retro" />
							</a>
							<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
								{{comment.postsforcomments.post.user.displayname}}
								<span ng-if="canManagePosts && comment.postsforcomments.post.user.fullname">
									({{comment.postsforcomments.post.user.fullname}})
								</span>
								<span ng-if="canManagePosts && !comment.postsforcomments.post.user.fullname">
									({{comment.postsforcomments.post.user.username}})
								</span>
							</a>
							<span class="label label-info" ng-if="instructors[comment.postsforcomments.post.user.id]">
								{{instructors[comment.postsforcomments.post.user.id]}} 
							</span>
							<strong>replied</strong> on {{comment.postsforcomments.post.created | amDateFormat: 'MMM D @ h:mm a'}}:
							<div class="manager-actions pull-right" ng-if="canManagePosts || comment.postsforcomments.post.user.id == loggedInUserId">
								<a href="" confirmation-needed="deleteReply(answerKey, commentKey, courseId, question.id, answer.id, comment.id)" keyword="reply">
									<i class="fa fa-trash-o"></i>
								</a>
								<a href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/comment/{{comment.id}}/edit">
									Edit
								</a>
							</div>
							
							<!-- Instructor Reply -->
							<div class="content" mathjax="comment.content"
								 ng-bind-html="comment.content">
							</div>
						
						</div><!-- closes each-reply (instructor) -->
						
					</div><!--closes toggle div -->
					
					<p><a ng-if="question.can_reply || canManagePosts" href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/comment/create" class="btn btn-sm btn-primary pull-left">
						Reply
					</a></p>
				
				</div><!-- closes each-answer (instructor) -->
				
				<!-- Student Answers Section -->
				<div class="each-answer clearfix" ng-repeat="(answerKey, answer) in answers | filter:groupFilter() | orderBy:order:reverse | notScoredEnd:grade.sortby as results" ng-if="!instructors[answer.post.user.id] && (see_answers || answer.post.user.id == loggedInUserId || canManagePosts)">
				<!-- <div class="each-answer clearfix" ng-repeat="(answerKey, answer) in answers" ng-if="!instructors[answer.post.user.id] && (see_answers || (answer.post.user.id == loggedInUserId && question.answer_period) || canManagePosts)"> -->
					<!-- Student Answer Metadata Header -->
					<a ng-href="#/user/{{answer.post.user.id}}">
						<img src="//www.gravatar.com/avatar/{{answer.post.user.avatar}}?s=32&d=retro" />
					</a>
					<a ng-href="#/user/{{answer.post.user.id}}">
						{{answer.post.user.displayname}}
						<span ng-if="canManagePosts && answer.post.user.fullname">
							({{answer.post.user.fullname}})
						</span>
						<span ng-if="canManagePosts && !answer.post.user.fullname">
							({{answer.post.user.username}})
						</span>
					</a>
					<strong>answered</strong> on {{answer.post.created | amDateFormat: 'MMM D @ h:mm a'}}:
					<div class="manager-actions pull-right" ng-if="canManagePosts || (answer.post.user.id == loggedInUserId && question.answer_period)">
						<span ng-if="answer.flagged" class="text-warning" title="Answer was flagged by a student as incomplete or inappropriate">
							<i class="fa fa-warning"></i>
							Flagged
						</span>
						<a href="" confirmation-needed="deleteAnswer(answerKey, courseId, question.id, answer.id)" keyword="answer">
							<i class="fa fa-trash-o"></i>
						</a>
						<a href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/edit">
							Edit
						</a>
					</div>

					<!-- Student Answer -->
					<div class="content {{answer.post.id}}" get-height>
						<div mathjax="answer.post.content"
							 ng-bind-html="answer.post.content">
						</div>
						<!-- Student Attachment -->
						<acj-pdf-inline label="See question details:"
							pdfs="answer.post.files" ng-click="revealAnswer(answer.post.id)">
						</acj-pdf-inline>
					</div>
					<!-- Student Answer Read More Button (not used for instructor answers) -->
					<p ng-show="showReadMore" class="read-more" ng-click="revealAnswer(answer.post.id)"><a href="" class="btn btn-sm btn-default">Read More...</a></p>
					<!-- <p ng-show="!showReadMore">No More To Read!!! ({{thisHeight}})</p> -->

					<!-- Student Score (not used for instructor answers) -->
					<p class="pull-right" ng-show="canManagePosts && key==grade.sortby && answer.scores.length > 0" ng-repeat="(key, score) in answer.scores" class="score-display">
						<em>Score: {{score.normalized_score}}%</em>
					</p>
					<p class="pull-right" ng-show="canManagePosts && answer.scores.length == 0" class="score-display">
						<em>Not Evaluated</em>
					</p>

					<!-- Student Answer Replies Section -->
					<a href="" ng-click="showReplies = !showReplies">
						<h3 class="reply-heading" ng-if="answer.comments.length && (see_answers || canManagePosts)">
							<i class="fa fa-chevron-down" ng-show="showReplies"></i>
							<i class="fa fa-chevron-right" ng-hide="showReplies"></i>
							{{answer.comments.length}}
							<span ng-if="answer.comments.length == 1">reply</span>
							<span ng-if="answer.comments.length > 1">replies</span>
							to this answer
						</h3>
					</a>

					<div ng-show="showReplies">

						<div ng-repeat="comment in answer.comments" class="each-reply" ng-if="see_answers || canManagePosts">

							<hr ng-hide="$first" />

							<!-- Student Reply Metadata Header -->
							<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
								<img src="//www.gravatar.com/avatar/{{comment.postsforcomments.post.user.avatar}}?s=32&d=retro" />
							</a>
							<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
								{{comment.postsforcomments.post.user.displayname}}
								<span ng-if="canManagePosts && comment.postsforcomments.post.user.fullname">
									({{comment.postsforcomments.post.user.fullname}})
								</span>
								<span ng-if="canManagePosts && !comment.postsforcomments.post.user.fullname">
									({{comment.postsforcomments.post.user.username}})
								</span>
							</a>
							<span class="label label-info" ng-if="instructors[comment.postsforcomments.post.user.id]">
								{{instructors[comment.postsforcomments.post.user.id]}}
							</span>
							<span class="label label-info" ng-if="comment.selfeval">Self-Evaluation</span>
							<span class="label label-info" ng-if="comment.evaluation">Evaluation</span>
							<strong>replied</strong> on {{comment.postsforcomments.post.created | amDateFormat: 'MMM D @ h:mm a'}}:
							<div class="manager-actions pull-right" ng-if="canManagePosts || (comment.postsforcomments.post.user.id == loggedInUserId && !(comment.selfeval || comment.evaluation))">
								<a href="" confirmation-needed="deleteReply(answerKey, commentKey, courseId, question.id, answer.id, comment.id)" keyword="reply">
									<i class="fa fa-trash-o"></i>
								</a>
								<a href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/comment/{{comment.id}}/edit">
									Edit
								</a>
							</div>

							<!-- Student Reply -->
							<div class="content" mathjax="comment.content"
								 ng-bind-html="comment.content">
							</div>

						</div><!-- closes each-reply (student) -->

					</div><!-- closes toggle div -->

					<p><a ng-if="question.can_reply || canManagePosts" href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/comment/create" class="btn btn-sm btn-primary">
						Reply
					</a></p>

				</div><!-- closes each-answer (student) -->

				<div class="each-answer clearfix" ng-if="results.length < 1">
					<p>No answers were found with these filter settings. Try another choice above.</p>
				</div>
				
			</div><!-- closes answered show-hide div -->
		
		</div><!-- closes answers-tab -->
		
		<div class="tab-pane" id="comments-tab">
		
			<!-- Comments Tab Header -->
			<div class="tab-header">
				<a href="#/course/{{courseId}}/question/{{question.id}}/comment/create" class="btn btn-primary pull-right">
					Comment
				</a>
				<h2>Help for this assignment</h2>
				<p class="intro-text">Ask or answer a question about the assignment by adding a comment here.</p>
				<p ng-if="!question.comments_count">
					No help comments have been left for this question yet. Would you like to <a href="#/course/{{courseId}}/question/{{question.id}}/comment/create">add a comment</a> for this assignment?
				</p>
			</div>
			
			<!-- Comments Section -->
			<div ng-repeat="(commentKey, comment) in comments" class="each-comment">
				
				<!-- Comment Metadata Header -->
				<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
					<img src="//www.gravatar.com/avatar/{{comment.postsforcomments.post.user.avatar}}?s=32&d=retro" />
				</a>
				<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
					{{comment.postsforcomments.post.user.displayname}}
					<span ng-if="canManagePosts && comment.postsforcomments.post.user.fullname">
						({{comment.postsforcomments.post.user.fullname}})
					</span>
					<span ng-if="canManagePosts && !comment.postsforcomments.post.user.fullname">
						({{comment.postsforcomments.post.user.username}})
					</span>
				</a>
				<span class="label label-info" ng-if="instructors[comment.postsforcomments.post.user.id]">
					{{instructors[comment.postsforcomments.post.user.id]}} 
				</span>
				<strong>commented</strong> on {{comment.postsforcomments.post.created | amDateFormat: 'MMM D @ h:mm a'}}:
				<div class="manager-actions pull-right" ng-if="canManagePosts || comment.postsforcomments.post.user.id == loggedInUserId">
					<a confirmation-needed="deleteComment(commentKey, courseId, question.id, comment.id)" keyword="comment">
						<i class="fa fa-trash-o"></i>
					</a>
					<a href="#/course/{{courseId}}/question/{{question.id}}/comment/{{comment.id}}/edit">
						Edit
					</a>
				</div>
				
				<!-- Comment -->
				<div class="content" mathjax="comment.content"
					 ng-bind-html="comment.content">
				</div>
			
			</div><!-- closes each-comment -->
			
		</div><!-- closes comments-tab -->

		<div class="tab-pane" id="participation-tab" ng-if="canManagePosts">
			<ng-include src="'modules/gradebook/gradebook-partial.html'"></ng-include>
		</div><!-- closes gradebook-tab -->
		
	</div><!-- closes tab-content -->
	
</div>
