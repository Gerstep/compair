<div ng-controller="QuestionViewController" class="question-screen">
	
	<div class="standalone-question">
		
		<!-- Question -->
		<h2><i class="fa fa-comments"></i> {{question.title}}</h2>
		
		<!-- Question Details -->
		<div class="questionmathjax question-desc" mathjax="question.post.content"
		     ng-bind-html="question.post.content">
		</div>
		
		<!-- Question Attachment -->
		<p class="question-desc" ng-if="question.post.files.length">
			See question details:
			<span ng-repeat="file in question.post.files">
				<a target="_blank" ng-href="#/course/{{courseId}}/question/{{question.id}}/post/{{question.post.id}}">{{file.alias}} <i class="fa fa-file-pdf-o"></i></a>
			</span>
		</p>
		
		<!-- Question Answer/Evaluation Periods -->
		<div ng-show="canManagePosts">
			<p><strong>Answering Period:</strong> {{question.answer_start | amDateFormat: 'MMM D @ h:mm a'}} - {{question.answer_end | amDateFormat: 'MMM D @ h:mm a'}}
			<span ng-if="question.judge_start > 0 && question.judge_end > 0"><br /><strong>Evaluation Period:</strong> {{question.judge_start | amDateFormat: 'MMM D @ h:mm a'}} - {{question.judge_end | amDateFormat: 'MMM D @ h:mm a'}}</p>
		</div>
		
		<!-- Question Metadata Footer -->
		<ul class="list-inline">
			<li ng-if="canManagePosts || question.post.user.id == loggedInUserId">	
				<a ng-href="#/course/{{courseId}}/question/{{question.id}}/edit" ng-if="canManagePosts || question.post.user.id == loggedInUserId" title="Edit">
					Edit
				</a> 
			</li>
			<li>
				Posted by 
				<a ng-href="#/user/{{question.post.user.id}}">
					{{question.post.user.displayname}}
					<span ng-if="canManagePosts && question.post.user.fullname">
						({{question.post.user.fullname}})
					</span>
					<span ng-if="canManagePosts && !question.post.user.fullname">
						({{question.post.user.username}})
					</span>
				</a>
			</li>
			<li ng-if="!canManagePosts && question.answer_period">
				Answer due {{question.answer_end | amDateFormat: 'MMM D @ h:mm a'}}
			</li>
			<li ng-if="canManagePosts || question.post.user.id == loggedInUserId">
				<a ng-if="canManagePosts || question.post.user.id == loggedInUserId" title="Delete" confirmation-needed="deleteQuestion(courseId, question.id)" keyword="question">
					<i class="fa fa-trash-o"></i>
				</a>
			</li>
		</ul>
		
		<!-- Question Action Buttons -->
		<a ng-href="#/course/{{courseId}}/question/{{question.id}}/answer/create" class="btn btn-success" title="Answer"
		   ng-show="!answered && (canManagePosts || question.answer_period)">
			Answer
		</a>
		<a class="btn btn-success" ng-show="answered && (canManagePosts || question.answer_period)" title="You have answered" disabled>
			Answered
		</a>
		<a class="btn btn-success" title="Evaluate Answers" ng-href="#/course/{{courseId}}/question/{{question.id}}/judgement"
		   ng-show="!canManagePosts && question.judging_period && !judged_req_met">
			Evaluate
		</a>
		<a class="btn btn-success" title="You have evaluated" ng-href="#/course/{{courseId}}/question/{{question.id}}/judgement"
		   ng-show="!canManagePosts && question.judging_period && judged_req_met" disabled>
			Evaluated
		</a>
		<a class="btn btn-success" title="Evaluations" ng-href="#/course/{{courseId}}/question/{{question.id}}/evaluations"
		   ng-show="canManagePosts && (question.judging_period || question.after_judging)">
			See Evaluations
		</a>
		
	</div><!-- closes question box -->
	
	<!-- Tabs -->
	<ul class="nav nav-tabs" role="tablist">
	  <li id="answers" class="active">
		<a href="#answers-tab">Answers <span ng-show="canManagePosts || !question.answer_period">({{question.answers_count}})</span></a>
	  </li>
	  <li id="comments">
		<a href="#comments-tab">Comments ({{question.comments_count}})</a>
	  </li>
	</ul>
	
	<!-- Tab Content -->
	<div class="tab-content">
		
		<div class="tab-pane active" id="answers-tab">
			
			<!-- Answers Tab Header -->
			<div class="tab-header">
				
				<!-- placeholder for filter **DOES NOT YET WORK** -->
				<div ng-if="canManagePosts" class="pull-right">
					<label>Sort by ranking for: &nbsp;</label>
					<select ng-model="sortby" class="nullable"
						ng-options="key as c.criterion.name for (key, c) in criteria">
						<option value="">- select criterion -</option>
					</select>
					<a class="print-btn" href="" onclick="window.print();">
						<i class="fa fa-print"></i>
					</a>
				</div>
				
				<h2>Answers</h2>
				
				<!-- Instructors see before the answer period -->
				<p ng-if="canManagePosts && !question.answer_period && !question.answers_count">
					Answering period begins {{question.answer_start | amDateFormat: 'MMM D @ h:mm a'}}. Would you like to <a ng-href="#/course/{{courseId}}/question/{{question.id}}/edit" title="Edit the question">change the answer dates</a> for this question?
				</p>
				<!-- Students see before answering during the answer period -->
				<p ng-if="!canManagePosts && !answered && question.answer_period">
					<a ng-href="#/course/{{courseId}}/question/{{question.id}}/answer/create" title="Answer the question">Answer</a> and evaluate the question first, then read answers written by your classmates and instructors here.
				</p>
				<!-- Students see before evaluating before the evaluation period -->
				<p ng-if="!canManagePosts && answered && !judged_req_met && !question.judging_period">
					Evaluation period begins <span ng-if="question.judge_start > 0">{{question.judge_start | amDateFormat: 'MMM D @ h:mm a'}}</span><span ng-if="question.judge_start <= 0">after the answer period ends</span>. After evaluating, you will be able to read answers written by your classmates and instructors here.
				</p>
				<!-- Students see before evaluating during the evaluation period -->
				<p ng-if="!canManagePosts && question.judging_period && !judged_req_met">
					<a ng-href="#/course/{{courseId}}/question/{{question.id}}/judgement" title="Answer the question">Evaluate</a> the question first, then read answers written by your classmates and instructors here.
				</p>
				<!-- Anyone sees during the answer period, if no answers provided yet -->
				<p ng-if="question.answer_period && !question.answers_count">
					No answers given for this question yet.
				</p>
				<!-- Students see after evaluating before the evaluation period is over -->
				<p ng-if="!canManagePosts && !see_answers && judged_req_met">
					You have successfully met the requirements for this question. Answers written by your classmates and instructors will be available here beginning <strong>{{ answerAvail | amDateFormat: 'MMM D @ h:mm a'}}</strong>.
				</p>
			</div>
			
			<div class="all-answers">
			
				<!-- Instructor Answers Section -->
				<div class="each-answer clearfix" ng-repeat="(answerKey, answer) in answers" ng-if="instructors[answer.post.user.id] && (see_answers || canManagePosts)">
					
					<!-- Instructor Answer Metadata Header -->
					<a ng-href="#/user/{{answer.post.user.id}}">
						<img src="//www.gravatar.com/avatar/{{answer.post.user.avatar}}?s=32&d=retro" />
					</a>
					<a ng-href="#/user/{{answer.post.user.id}}">
						{{answer.post.user.displayname}}
						<span ng-if="canManagePosts && answer.post.user.fullname">
							({{answer.post.user.fullname}})
						</span>
						<span ng-if="canManagePosts && !answer.post.user.fullname">
							({{answer.post.user.username}})
						</span>
					</a>
					<span class="label label-info" ng-if="instructors[answer.post.user.id]">{{instructors[answer.post.user.id]}}&nbsp;</span>
					<strong>final answer</strong>:
					<div class="manager-actions pull-right" ng-if="canManagePosts">
						<a href="" confirmation-needed="deleteAnswer(answerKey, courseId, question.id, answer.id)" keyword="instructor answer">
							<i class="fa fa-trash-o"></i>
						</a>
						<a href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/edit">
							Edit
						</a>
					</div>
					
					<!-- Instructor Answer -->
					<div class="content">
						<div mathjax="answer.post.content"
							ng-bind-html="answer.post.content">
						</div>
						<!-- Instructor Attachment -->
						<p ng-if="answer.post.files.length">
							See answer details:
							<span ng-repeat="file in answer.post.files">
								<a target="_blank" ng-href="#/course/{{courseId}}/question/{{questionId}}/post/{{answer.post.id}}">{{file.alias}} <i class="fa fa-file-pdf-o"></i></a>
							</span>
						</p>
					</div>
					
					<!-- Instructor Answer Replies Section -->
					<a href="" ng-click="showReplies = !showReplies">			
						<h3 class="reply-heading" ng-if="answer.comments.length">
							<i class="fa fa-chevron-down" ng-show="showReplies"></i>
							<i class="fa fa-chevron-right" ng-hide="showReplies"></i>
							{{answer.comments.length}}
							<span ng-if="answer.comments.length == 1">reply</span>
							<span ng-if="answer.comments.length > 1">replies</span>
							to instructor's answer
						</h3>
					</a>
					
					<div ng-show="showReplies">
						
						<div ng-repeat="(commentKey, comment) in answer.comments" class="each-reply" >
							
							<hr ng-hide="$first" />
							
							<!-- Instructor Reply Metadata Header -->
							<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
								<img src="//www.gravatar.com/avatar/{{comment.postsforcomments.post.user.avatar}}?s=32&d=retro" />
							</a>
							<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
								{{comment.postsforcomments.post.user.displayname}}
								<span ng-if="canManagePosts && comment.postsforcomments.post.user.fullname">
									({{comment.postsforcomments.post.user.fullname}})
								</span>
								<span ng-if="canManagePosts && !comment.postsforcomments.post.user.fullname">
									({{comment.postsforcomments.post.user.username}})
								</span>
							</a>
							<span class="label label-info" ng-if="instructors[comment.postsforcomments.post.user.id]">
								{{instructors[comment.postsforcomments.post.user.id]}} 
							</span>
							<strong>replied</strong> on {{comment.postsforcomments.post.created | amDateFormat: 'MMM D @ h:mm a'}}:
							<div class="manager-actions pull-right" ng-if="canManagePosts || comment.postsforcomments.post.user.id == loggedInUserId">
								<a href="" confirmation-needed="deleteReply(answerKey, commentKey, courseId, question.id, answer.id, comment.id)" keyword="reply">
									<i class="fa fa-trash-o"></i>
								</a>
								<a href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/comment/{{comment.id}}/edit">
									Edit
								</a>
							</div>
							
							<!-- Instructor Reply -->
							<div class="content" mathjax="comment.content"
							     ng-bind-html="comment.content">
							</div>
						
						</div><!-- closes each-reply (instructor) -->
						
					</div><!--closes toggle div -->
					
					<p><a ng-if="question.can_reply || canManagePosts" href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/comment/create" class="btn btn-sm btn-primary pull-left">
						Reply
					</a></p>
				
				</div><!-- closes each-answer (instructor) -->
				
				<!-- Student Answers Section -->
				<div class="each-answer clearfix" ng-repeat="(answerKey, answer) in answers | orderBy:order:reverse | notScoredEnd:sortby" ng-if="!instructors[answer.post.user.id] && (see_answers || answer.post.user.id == loggedInUserId || canManagePosts)">
				<!-- <div class="each-answer clearfix" ng-repeat="(answerKey, answer) in answers" ng-if="!instructors[answer.post.user.id] && (see_answers || (answer.post.user.id == loggedInUserId && question.answer_period) || canManagePosts)"> -->
					
					<!-- Student Answer Metadata Header -->
					<a ng-href="#/user/{{answer.post.user.id}}">
						<img src="//www.gravatar.com/avatar/{{answer.post.user.avatar}}?s=32&d=retro" />
					</a>
					<a ng-href="#/user/{{answer.post.user.id}}">
						{{answer.post.user.displayname}}
						<span ng-if="canManagePosts && answer.post.user.fullname">
							({{answer.post.user.fullname}})
						</span>
						<span ng-if="canManagePosts && !answer.post.user.fullname">
							({{answer.post.user.username}})
						</span>
					</a>
					<strong>answered</strong> on {{answer.post.created | amDateFormat: 'MMM D @ h:mm a'}}:
					<div class="manager-actions pull-right" ng-if="canManagePosts || (answer.post.user.id == loggedInUserId && question.answer_period)">
						<span ng-if="answer.flagged" class="text-warning" title="Answer was flagged by a student as incomplete or inappropriate">
							<i class="fa fa-warning"></i>
							Flagged
						</span>
						<a href="" confirmation-needed="deleteAnswer(answerKey, courseId, question.id, answer.id)" keyword="answer">
							<i class="fa fa-trash-o"></i>
						</a>
						<a href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/edit">
							Edit
						</a>
					</div>
					
					<!-- Student Answer -->
					<div class="content {{answer.post.id}}" get-height>
						<div mathjax="answer.post.content"
						     ng-bind-html="answer.post.content">
						</div>
						<!-- Student Attachment -->
						<p ng-if="answer.post.files.length">
							See answer details:
							<span ng-repeat="file in answer.post.files">
								<a target="_blank" ng-href="#/course/{{courseId}}/question/{{questionId}}/post/{{answer.post.id}}">{{file.alias}} <i class="fa fa-file-pdf-o"></i></a>
							</span>
						</p>
					</div>
					<!-- Student Answer Read More Button (not used for instructor answers) -->
					<p ng-show="showReadMore" class="read-more" ng-click="revealAnswer(answer.post.id)"><a href="" class="btn btn-sm btn-default">Read More...</a></p>
					<!-- <p ng-show="!showReadMore">No More To Read!!! ({{thisHeight}})</p> -->
					
					<!-- Student Score (not used for instructor answers) -->
					<p class="pull-right" ng-show="canManagePosts && key==sortby && answer.scores.length > 0" ng-repeat="(key, score) in answer.scores" class="score-display">
						<em>Score: {{score.score | number: 3}}</em>
					</p>
					
					<!-- Student Answer Replies Section -->
					<a href="" ng-click="showReplies = !showReplies">
						<h3 class="reply-heading" ng-if="answer.comments.length && (see_answers || canManagePosts)">
							<i class="fa fa-chevron-down" ng-show="showReplies"></i>
							<i class="fa fa-chevron-right" ng-hide="showReplies"></i>
							{{answer.comments.length}}
							<span ng-if="answer.comments.length == 1">reply</span>
							<span ng-if="answer.comments.length > 1">replies</span>
							to this answer
						</h3>
					</a>
					
					<div ng-show="showReplies">
						
						<div ng-repeat="comment in answer.comments" class="each-reply" ng-if="see_answers || canManagePosts">
							
							<hr ng-hide="$first" />
							
							<!-- Student Reply Metadata Header -->
							<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
								<img src="//www.gravatar.com/avatar/{{comment.postsforcomments.post.user.avatar}}?s=32&d=retro" />
							</a>
							<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
								{{comment.postsforcomments.post.user.displayname}}
								<span ng-if="canManagePosts && comment.postsforcomments.post.user.fullname">
									({{comment.postsforcomments.post.user.fullname}})
								</span>
								<span ng-if="canManagePosts && !comment.postsforcomments.post.user.fullname">
									({{comment.postsforcomments.post.user.username}})
								</span>
							</a>
							<span class="label label-info" ng-if="instructors[comment.postsforcomments.post.user.id]">
								{{instructors[comment.postsforcomments.post.user.id]}} 
							</span>
							<strong>replied</strong> on {{comment.postsforcomments.post.created | amDateFormat: 'MMM D @ h:mm a'}}:
							<div class="manager-actions pull-right" ng-if="canManagePosts || comment.postsforcomments.post.user.id == loggedInUserId">
								<a href="" confirmation-needed="deleteReply(answerKey, commentKey, courseId, question.id, answer.id, comment.id)" keyword="reply">
									<i class="fa fa-trash-o"></i>
								</a>
								<a href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/comment/{{comment.id}}/edit">
									Edit
								</a>
							</div>
							
							<!-- Student Reply -->
							<div class="content" mathjax="comment.content"
							     ng-bind-html="comment.content">
							</div>
							
						</div><!-- closes each-reply (student) -->
						
					</div><!-- closes toggle div -->
					
					<p><a ng-if="question.can_reply || canManagePosts" href="#/course/{{courseId}}/question/{{question.id}}/answer/{{answer.id}}/comment/create" class="btn btn-sm btn-primary">
						Reply
					</a></p>
					
				</div><!-- closes each-answer (student) -->
				
			</div><!-- closes answered show-hide div -->
		
		</div><!-- closes answers-tab -->
		
		<div class="tab-pane" id="comments-tab">
		
			<!-- Comments Tab Header -->
			<div class="tab-header">
				<a href="#/course/{{courseId}}/question/{{question.id}}/comment/create" class="btn btn-primary pull-right">
					Comment
				</a>
				<h2>Question comments</h2>
				<p>Ask your instructor about the question or leave a question-related comment for classmates.</p>
			</div>
			
			<!-- Comments Section -->
			<div ng-repeat="(commentKey, comment) in comments" class="each-comment">
				
				<!-- Comment Metadata Header -->
				<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
					<img src="//www.gravatar.com/avatar/{{comment.postsforcomments.post.user.avatar}}?s=32&d=retro" />
				</a>
				<a ng-href="#/user/{{comment.postsforcomments.post.user.id}}">
					{{comment.postsforcomments.post.user.displayname}}
					<span ng-if="canManagePosts && comment.postsforcomments.post.user.fullname">
						({{comment.postsforcomments.post.user.fullname}})
					</span>
					<span ng-if="canManagePosts && !comment.postsforcomments.post.user.fullname">
						({{comment.postsforcomments.post.user.username}})
					</span>
				</a>
				<span class="label label-info" ng-if="instructors[comment.postsforcomments.post.user.id]">
					{{instructors[comment.postsforcomments.post.user.id]}} 
				</span>
				<strong>commented</strong> on {{comment.postsforcomments.post.created | amDateFormat: 'MMM D @ h:mm a'}}:
				<div class="manager-actions pull-right" ng-if="canManagePosts || comment.postsforcomments.post.user.id == loggedInUserId">
					<a confirmation-needed="deleteComment(commentKey, courseId, question.id, comment.id)" keyword="comment">
						<i class="fa fa-trash-o"></i>
					</a>
					<a href="#/course/{{courseId}}/question/{{question.id}}/comment/{{comment.id}}/edit">
						Edit
					</a>
				</div>
				
				<!-- Comment -->
				<div class="content" mathjax="comment.content"
				     ng-bind-html="comment.content">
				</div>
			
			</div><!-- closes each-comment -->
			
		</div><!-- closes comments-tab -->
		
	</div><!-- closes tab-content -->
	
</div>
